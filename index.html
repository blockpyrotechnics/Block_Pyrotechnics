<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Block Pyrotechnics – Shop</title>
  <meta name="theme-color" content="#0d0f12" />
  <style>
    :root{
      --bg:#0b0d10; --bg-2:#10141b; --card:#121722; --muted:#7c8aa0; --text:#e9eef7;
      --accent:#00f0ff; --accent-2:#ff00a8; --ok:#20d37c; --warn:#ffcc00; --error:#ff5b5b;
      --shadow:0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
      --radius:18px; --neon:#39ff14; --oos:#ff9a3f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%,rgba(0,240,255,.08),transparent 60%),
        radial-gradient(800px 600px at 110% 10%,rgba(255,0,168,.06),transparent 50%),
        var(--bg);
      color:var(--text);
      font:500 15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
    }
    a{color:var(--accent);text-decoration:none}
    header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(130%) blur(8px);
      background:linear-gradient(180deg, rgba(12,16,22,.85), rgba(12,16,22,.65));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px}
    .row{display:flex;align-items:center;gap:12px}
    .space{flex:1}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;}
    .logo-badge{width:34px; height:34px; border-radius:50%;
      background:conic-gradient(from 120deg at 50% 50%, var(--accent), var(--accent-2));
      box-shadow:0 0 12px rgba(0,240,255,.35), 0 0 24px rgba(255,255,255,.2) inset;
    }
    .btn{
      appearance:none; border:0; border-radius:14px; padding:10px 14px;
      background:linear-gradient(180deg, #111625,#0f1420);
      color:var(--text); box-shadow:var(--shadow); cursor:pointer;
      transition:.2s transform, .2s opacity, .2s box-shadow;
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap; user-select:none;
    }
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.ghost{background:rgba(255,255,255,.06);box-shadow:none;border:1px solid rgba(255,255,255,.08)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(0,240,255,.18), rgba(0,240,255,.08));
      border:1px solid rgba(0,240,255,.35);
      box-shadow:0 6px 22px rgba(0,240,255,.12), inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .chip{padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04); display:inline-flex; gap:8px; align-items:center; cursor:pointer; user-select:none;
    }
    .chip.active{border-color:rgba(0,240,255,.5); box-shadow:0 0 0 2px rgba(0,240,255,.12) inset}
    .search{ position:relative; flex:1; min-width:160px;}
    .search input{
      width:100%; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04); color:var(--text); outline:none; box-shadow:var(--shadow);
    }
    .search input::placeholder{color:#99a7bf}
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:14px; padding:16px; }
    .card{
      background:linear-gradient(180deg, #0f141e, #0d131c);
      border-radius:var(--radius); box-shadow:var(--shadow); position:relative; overflow:hidden;
      display:flex; flex-direction:column;
    }
    .card .img{
      aspect-ratio: 4/3; background:#0b0f16; display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .card img{max-width:100%; max-height:100%; object-fit:contain; display:block; filter:drop-shadow(0 10px 30px rgba(0,0,0,.5))}
    .card .content{padding:12px 12px 14px}
    .card h3{margin:0 0 6px; font-size:15px}
    .price{display:flex; align-items:baseline; gap:8px}
    .price .now{font-weight:800}
    .price .old{opacity:.6; text-decoration:line-through}
    /* neue Zeile: Preis links, Status rechts */
    .price-row{ display:flex; align-items:center; gap:10px; margin-top:6px; }
    .status-badges{
      display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-left:auto;
    }
    .sbadge{
      font-size:12px; padding:6px 8px; border-radius:10px; font-weight:800;
      border:1px solid rgba(255,255,255,.12); backdrop-filter:blur(3px);
    }
    .s-available{ background:rgba(32,211,124,.18); color:#c9ffdf; border-color:rgba(32,211,124,.45) }
    .s-oos{ background:rgba(255,154,63,.18); color:#ffd9b7; border-color:rgba(255,154,63,.45) }
    .s-na{ background:rgba(255,91,91,.18); color:#ffd2d2; border-color:rgba(255,91,91,.45) }
    .s-own{ background:rgba(57,255,20,.12); color:#d6ffd0; border-color:rgba(57,255,20,.45); text-shadow:0 0 6px rgba(57,255,20,.5) }

    .y-badge{ position:absolute; top:10px; left:10px; background:#ff0000; color:#fff;
      padding:6px 8px; border-radius:10px; font-size:12px; font-weight:700; cursor:pointer;
    }

    .card .actions{display:flex; gap:8px; margin-top:10px}
    .floating{ position:fixed; bottom:16px; right:16px; display:flex; gap:8px; z-index:60; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:84px; background:#111825;
      border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 14px; box-shadow:var(--shadow); z-index:70; display:none;
    }

    /* Admin Panel */
    #adminPanel{
      position:fixed; top:0; right:0; height:100vh; width:min(480px, 94vw); z-index:10000;
      background:linear-gradient(180deg, #0d121c, #0a0f17);
      border-left:1px solid rgba(255,255,255,.08);
      box-shadow:-16px 0 50px rgba(0,0,0,.55); display:none; flex-direction:column; overflow:hidden;
    }
    #adminPanel .head{display:flex; align-items:center; gap:10px; padding:14px; border-bottom:1px solid rgba(255,255,255,.06); position:sticky; top:0; z-index:70}
    #adminTabs{ display:flex; gap:8px; }
    #adminPanel .tools{display:grid; grid-template-columns:1fr 1fr; gap:8px; padding:12px 14px}
    #adminPanel .tools .btn{justify-content:center}
    .admin-filters{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding:0 14px 12px 14px; border-bottom:1px solid rgba(255,255,255,.06) }
    .admin-filters input, .admin-filters select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04); color:var(--text); outline:none;
    }
    #adminPanel .list{flex:1; overflow:auto; padding:10px 14px; display:flex; flex-direction:column; gap:8px}
    .admin-item{padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04); display:grid; grid-template-columns:1fr; gap:8px}
    .admin-item input, .admin-item select, .admin-item textarea{
      width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04); color:var(--text); outline:none;
    }
    .pill{font-size:12px; padding:5px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08)}
    .toggle-group{ display:flex; flex-wrap:wrap; gap:6px; }
    .tbtn{ padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.06); cursor:pointer; font-weight:700 }
    .tbtn.active{ box-shadow:0 0 0 2px rgba(255,255,255,.08) inset }
    .t-available{ background:rgba(32,211,124,.15); border-color:rgba(32,211,124,.35) }
    .t-oos{ background:rgba(255,154,63,.15); border-color:rgba(255,154,63,.35) }
    .t-na{ background:rgba(255,91,91,.15); border-color:rgba(255,91,91,.35) }
    .t-own{ background:rgba(57,255,20,.12); border-color:rgba(57,255,20,.45) }

    /* Modals */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:400000; background:rgba(0,0,0,.5); backdrop-filter:blur(4px); pointer-events:auto}
    .modal .box{width:min(560px,92vw); background:linear-gradient(180deg, #111828, #0e1421); border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow); border-radius:16px; padding:14px; position:relative; z-index:400001; pointer-events:auto; max-height:min(92vh, 880px); display:flex; flex-direction:column; overflow:hidden}
    #loginModal .box{width:min(520px,92vw)}
    .muted{color:var(--muted)}
    .badge{display:inline-flex; align-items:center; justify-content:center; min-width:22px; height:22px; padding:0 6px; border-radius:999px; background:rgba(0,240,255,.18); border:1px solid rgba(0,240,255,.35); font-size:12px; margin-left:6px}
    .hidden{display:none !important}
    .nowrap{white-space:nowrap}
    .right{margin-left:auto}
    header, #adminPanel, .floating, .toast, .modal{pointer-events:auto}
    body.modal-open > *:not(.modal){ pointer-events:none !important; }
    .modal *{pointer-events:auto}
    .modal button{position:relative; z-index:400002}

    /* Orders */
    .summary-list{display:flex; flex-direction:column; gap:4px; margin:4px 0 6px}
    .summary-line{opacity:.9}
    .order-items{display:flex; flex-direction:column; gap:6px}
    .order-row{display:grid; grid-template-columns:minmax(180px,3.4fr) 64px 86px 56px auto; gap:6px; align-items:center}
    .order-row .chk{display:flex; align-items:center; justify-content:center}
    .order-head{display:grid; grid-template-columns:1fr 1fr; gap:8px}

    /* Mobile polish */
    html, body { overflow-x: hidden; overscroll-behavior-x: contain; touch-action: pan-y; }
    header .logo-img { height: 30px; width: auto; display: block; }
    .card img { margin:auto; display:block; }
    @media (max-width: 640px){
      :root{ --header-field-h: 52px; }
      header .wrap{ display:flex; align-items:center; gap:10px; padding:8px 12px; }
      header .logo span{ font-size:16px; line-height:1.1; max-width:40vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
      .search{ flex:1 1 auto; min-width:0 }
      #searchInput{ height: var(--header-field-h); padding: 0 14px; font-size: 16px; border-radius: 14px; }
      #btnCart{ height: var(--header-field-h); min-width: var(--header-field-h); padding: 0 14px; border-radius: 14px; display:flex; align-items:center; justify-content:center; line-height:1; }
      #adminPanel .tools{ grid-template-columns: 1fr 1fr; gap:10px; }
      .grid{ grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); padding: 12px; gap: 12px; }
      .order-row{ grid-template-columns:minmax(120px,2.8fr) 54px 76px 48px auto; }
      .price-row{ flex-wrap:wrap; row-gap:6px; }
      .status-badges{ margin-left:0; }
    }

    /* Product images fit + slight left shift */
    .card .img img{ width:100%; height:100%; object-fit:contain; transform: translateX(-6px); }
    @media (max-width: 640px){ .card .img img{ transform: translateX(-5px); } }

    /* Cart modal scrolling */
    #cartList{ flex:1 1 auto; min-height:0; overflow-y:auto; -webkit-overflow-scrolling: touch; }
    .cart-summary{ position:sticky; bottom:0; background:linear-gradient(180deg, rgba(16,20,27,.85), rgba(16,20,27,.95)); backdrop-filter:saturate(130%) blur(6px); padding-top:8px; }

    /* Admin tabs & scrolling safety */
    #adminPanel .head{ position:sticky; top:0; z-index:70; }
  </style>

  <!-- Touch Icon & PWA -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="manifest" href="site.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Block Pyrotechnics" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

</head>
<body>
  <header>
    <div class="wrap row">
      <div class="logo">
        <img id="brandLogo" class="logo-img" src="assets/logo.png" alt="Block Pyrotechnics Logo"/>
        <span>Block Pyrotechnics</span>
      </div>
      <div class="space"></div>
      <div class="search">
        <input id="searchInput" type="search" placeholder="Suche nach Artikeln…" autocorrect="off" autocapitalize="off" spellcheck="false" name="no-autofill" enterkeyhint="search" autocomplete="off" inputmode="search" autocapitalize="none" />
      </div>
      <button id="btnCart" class="btn primary" title="Warenkorb öffnen">Warenkorb <span id="cartBadge" class="badge hidden">0</span></button>
    </div>
  </header>

  <div class="wrap" style="padding-top:12px">
    <div id="categoryBar" class="row" style="flex-wrap:wrap; gap:10px; padding:8px 0">
      <div class="chip active" data-cat="alle">Alle</div>
      <div class="chip" data-cat="Raketen">Raketen</div>
      <div class="chip" data-cat="Verbünde">Verbünde</div>
      <div class="chip" data-cat="Batterien">Batterien</div>
      <div class="chip" data-cat="Böller">Böller</div>
      <div class="chip" data-cat="Vulkane">Vulkane</div>
      <div class="chip" data-cat="Fontänen">Fontänen</div>
      <div class="chip" data-cat="Leucht">Leucht</div>
      <div class="chip" data-cat="Sortiment">Sortiment</div>
      <div class="chip" data-cat="Sonstiges">Sonstiges</div>
      <span class="pill" id="statusPill">Status: <span id="statusText">Offline (lokal)</span></span>
    </div>
  </div>

  <main id="grid" class="grid" aria-live="polite"></main>

  <div class="floating">
    <button id="btnAdminOpen" class="btn ghost">Admin</button>
  </div>

  <div id="toast" class="toast">Hinweis</div>

  <!-- Admin Side Panel -->
  <aside id="adminPanel" role="dialog" aria-label="Admin Panel">
    <div class="head">
      <div class="title">Admin-Panel</div>
      <div id="adminTabs" class="row" style="margin-left:12px">
        <button id="btnTabProducts" class="btn ghost" type="button">Produkte</button>
        <button id="btnTabOrders" class="btn" type="button">Bestellungen</button>
      </div>
      <div class="space"></div>
      <button id="btnAdminClose" class="btn ghost" title="Panel schließen" type="button">Schließen</button>
      <button id="btnLogout" class="btn" title="Abmelden" type="button">Logout</button>
    </div>

    <!-- Schnelltools -->
    <div class="tools">
      <button id="btnAdd" class="btn" type="button">Artikel +</button>
      <button id="btnSaveAll" class="btn" type="button">Speichern</button>
      <button id="btnImport" class="btn" type="button">Import JSON</button>
      <button id="btnExport" class="btn" type="button">Export JSON</button>
      <button id="btnClearLocal" class="btn" type="button">Lokal löschen</button>
      <button id="btnCloudRetry" class="btn" type="button">Cloud neu verbinden</button>
      <button id="btnReload" class="btn" type="button">Neu laden</button>
      <button id="btnShowProducts" class="btn ghost" type="button">Produkte</button>
      <button id="btnShowOrders" class="btn" type="button">Bestellungen</button>
    </div>

    <!-- Admin Filter & Suche -->
    <div class="admin-filters" id="adminFilters">
      <input id="adminSearch" type="search" placeholder="Admin: Artikel suchen…" autocomplete="off" />
      <select id="adminCatFilter">
        <option value="">Alle Kategorien</option>
        <option>Raketen</option><option>Verbünde</option><option>Batterien</option>
        <option>Böller</option><option>Vulkane</option><option>Fontänen</option>
        <option>Leucht</option><option>Sortiment</option><option>Sonstiges</option>
      </select>
      <select id="adminStatusFilter">
        <option value="">Alle Status</option>
        <option value="available">Vorhanden</option>
        <option value="out_of_stock">Ausverkauft</option>
        <option value="not_available">Nicht erhältlich</option>
        <option value="own">Eigen Marke</option>
      </select>
    </div>

    <!-- Order Suche (nur sichtbar in Orders-Tab) -->
    <div class="admin-filters" id="orderFilters" style="display:none">
      <input id="orderSearch" type="search" placeholder="Bestellungen: Name oder Code…" autocomplete="off" />
      <div></div><div></div>
    </div>

    <div class="list" id="adminList"></div>
  </aside>

  <!-- Admin Login -->
  <div id="loginModal" class="modal">
    <div class="box">
      <h2>Admin Login</h2>
      <div class="form-row">
        <input id="loginEmail" type="email" name="email" placeholder="Admin-E-Mail (optional)" autocomplete="username email" inputmode="email" />
      </div>
      <div class="form-row">
        <input id="loginPass" type="password" name="current-password" placeholder="Passwort (oder Hauptcode)" autocomplete="current-password" />
      </div>
      <div class="row" style="margin-top:12px">
        <button id="loginCancel" class="btn ghost" type="button">Abbrechen</button>
        <div class="space"></div>
        <button id="loginOk" class="btn primary" type="button">Weiter</button>
      </div>
    </div>
  </div>

  <!-- Add / Edit Modal -->
  <div id="editModal" class="modal">
    <div class="box">
      <h2 id="editTitle">Artikel hinzufügen</h2>
      <div class="form-row">
        <input id="fName" placeholder="Name" autocomplete="off"/>
      </div>
      <div class="form-row">
        <select id="fCategory">
          <option>Raketen</option><option>Verbünde</option><option>Batterien</option>
          <option>Böller</option><option>Vulkane</option><option>Fontänen</option>
          <option>Leucht</option><option>Sortiment</option><option>Sonstiges</option>
        </select>
        <input id="fPrice" type="number" step="0.01" placeholder="Preis (€)" inputmode="decimal"/>
        <input id="fDiscount" type="number" step="1" min="0" max="95" placeholder="Rabatt (%)" inputmode="numeric"/>
      </div>
      <div class="form-row">
        <input id="fImage" placeholder="Bild-URL (https…)" />
      </div>
      <div class="form-row">
        <input id="fYouTube" placeholder="YouTube-URL (optional)" />
      </div>
      <div class="row" style="margin-top:12px">
        <button id="editCancel" class="btn ghost" type="button">Abbrechen</button>
        <div class="space"></div>
        <button id="editDelete" class="btn" type="button">Löschen</button>
        <button id="editSave" class="btn primary" type="button">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="modal">
    <div class="box">
      <h2>Warenkorb</h2>
      <div id="cartList" style="display:flex; flex-direction:column; gap:8px; margin-top:8px"></div>
      <div class="cart-summary">
        <span>Zwischensumme:</span>
        <span id="cartSubtotal">0,00 €</span>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="cartClose" class="btn ghost" type="button">Schließen</button>
        <div class="space"></div>
        <button id="cartClear" class="btn" type="button">Leeren</button>
        <button id="cartCheckout" class="btn primary" type="button">Bestellung abschließen</button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="modal">
    <div class="box">
      <h2>Bestellung abschließen</h2>
      <div class="form-row">
        <input id="coName" placeholder="Dein Name" autocomplete="name" />
      </div>
      <div class="form-row">
        <input id="coCode" placeholder="Bestell-Code" readonly />
      </div>
      <div class="muted">Merke dir den Code – mit dem können wir deine Bestellung schnell finden.</div>
      <div class="row" style="margin-top:12px">
        <button id="coCancel" class="btn ghost" type="button">Zurück</button>
        <div class="space"></div>
        <button id="coConfirm" class="btn primary" type="button">Jetzt absenden</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDWDrVw28pl9TayEq5FlsjHFxMK99P2d74",
      authDomain: "block-pyrotechnics.firebaseapp.com",
      projectId: "block-pyrotechnics",
      storageBucket: "block-pyrotechnics.firebasestorage.app",
      messagingSenderId: "578672617755",
      appId: "1:578672617755:web:2c46bfd14ba35799f40bbe",
      measurementId: "G-3QLL181155"
    };

    let app, auth, db;
    let cloudOK = false;
    let adminMode = false;
    let adminLocalPass = localStorage.getItem("bp_admin_code") || "BLOCK2025";
    let adminEmail = null;
    let unsubscribeProducts = null;
    let unsubscribeOrders = null;

    const ui = {
      grid: document.getElementById("grid"),
      search: document.getElementById("searchInput"),
      catBar: document.getElementById("categoryBar"),
      statusText: document.getElementById("statusText"),
      toast: document.getElementById("toast"),
      btnAdminOpen: document.getElementById("btnAdminOpen"),
      btnAdminClose: document.getElementById("btnAdminClose"),
      btnLogout: document.getElementById("btnLogout"),
      panel: document.getElementById("adminPanel"),
      list: document.getElementById("adminList"),
      btnAdd: document.getElementById("btnAdd"),
      btnSaveAll: document.getElementById("btnSaveAll"),
      btnImport: document.getElementById("btnImport"),
      btnExport: document.getElementById("btnExport"),
      btnClearLocal: document.getElementById("btnClearLocal"),
      btnCloudRetry: document.getElementById("btnCloudRetry"),
      btnReload: document.getElementById("btnReload"),
      btnShowProducts: document.getElementById("btnShowProducts"),
      btnShowOrders: document.getElementById("btnShowOrders"),
      loginModal: document.getElementById("loginModal"),
      loginEmail: document.getElementById("loginEmail"),
      loginPass: document.getElementById("loginPass"),
      loginCancel: document.getElementById("loginCancel"),
      loginOk: document.getElementById("loginOk"),
      editModal: document.getElementById("editModal"),
      editTitle: document.getElementById("editTitle"),
      fName: document.getElementById("fName"),
      fCategory: document.getElementById("fCategory"),
      fPrice: document.getElementById("fPrice"),
      fDiscount: document.getElementById("fDiscount"),
      fImage: document.getElementById("fImage"),
      fYouTube: document.getElementById("fYouTube"),
      editCancel: document.getElementById("editCancel"),
      editDelete: document.getElementById("editDelete"),
      editSave: document.getElementById("editSave"),
      btnCart: document.getElementById("btnCart"),
      cartBadge: document.getElementById("cartBadge"),
      cartModal: document.getElementById("cartModal"),
      cartList: document.getElementById("cartList"),
      cartSubtotal: document.getElementById("cartSubtotal"),
      cartClose: document.getElementById("cartClose"),
      cartClear: document.getElementById("cartClear"),
      cartCheckout: document.getElementById("cartCheckout"),
      checkoutModal: document.getElementById("checkoutModal"),
      coName: document.getElementById("coName"),
      coCode: document.getElementById("coCode"),
      coCancel: document.getElementById("coCancel"),
      coConfirm: document.getElementById("coConfirm"),

      // Admin filters
      adminSearch: document.getElementById("adminSearch"),
      adminCatFilter: document.getElementById("adminCatFilter"),
      adminStatusFilter: document.getElementById("adminStatusFilter"),
      orderFilters: document.getElementById("orderFilters"),
      adminFilters: document.getElementById("adminFilters"),
      orderSearch: document.getElementById("orderSearch"),
    };

    const LS_KEY = "bp_products_v1";
    const CART_KEY = "bp_cart_v1";
    const ORDERS_KEY = "bp_orders_v1";

    let products = new Map();
    let productsDraft = null;
    let currentCategory = "alle";
    let editingId = null;
    /** Map<id, qty> */
    let cart = new Map();
    /** Map<orderId, order> */
    let orders = new Map();
    let ordersDraft = new Map();
    let adminView = "products"; // or "orders"
    let adminSearchTerm = "";
    let adminCatTerm = "";
    let adminStatusTerm = "";
    let orderSearchTerm = "";

    function fmtEUR(v){ return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(Math.max(0, Number(v||0))); }
    function showToast(msg, ms=2000){ ui.toast.textContent = msg; ui.toast.style.display = "block"; clearTimeout(showToast._t); showToast._t = setTimeout(()=> ui.toast.style.display="none", ms); }

    function persistLocal(){ const obj = Object.fromEntries(products); localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
    function loadLocal(){ const raw = localStorage.getItem(LS_KEY); if(!raw) return; try{ const obj = JSON.parse(raw); products = new Map(Object.entries(obj)); } catch(e){ console.warn("Local parse failed", e) } }
    function saveCart(){ const obj = Object.fromEntries(cart); localStorage.setItem(CART_KEY, JSON.stringify(obj)); updateCartBadge(); }
    function loadCart(){ const raw = localStorage.getItem(CART_KEY); if(!raw) return; try{ const obj = JSON.parse(raw); cart = new Map(Object.entries(obj).map(([id,qty])=>[id, Number(qty)])); } catch(e){ console.warn("Cart parse failed", e) } updateCartBadge(); }
    function updateCartBadge(){ let c=0; for(const q of cart.values()) c+= Number(q)||0; if(c>0){ ui.cartBadge.textContent = String(c); ui.cartBadge.classList.remove("hidden"); } else { ui.cartBadge.classList.add("hidden"); } }
    function saveOrdersLocal(){ const obj = Object.fromEntries(orders); localStorage.setItem(ORDERS_KEY, JSON.stringify(obj)); }
    function loadOrdersLocal(){ const raw = localStorage.getItem(ORDERS_KEY); if(!raw) return; try{ const obj = JSON.parse(raw); orders = new Map(Object.entries(obj)); } catch(e){ console.warn("Orders parse failed", e) } }

    async function bootFirebase(){
      try{
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        cloudOK = true;
        ui.statusText.textContent = "Online (Cloud)";
      }catch(e){
        console.warn("Firebase init failed", e);
        cloudOK = false;
        ui.statusText.textContent = "Offline (lokal)";
      }
      bindAuthListener();
      if(cloudOK){ startProductsListener(); startOrdersListener(); } else { loadLocal(); loadOrdersLocal(); renderAll(); }
      loadCart();
    }

    function bindAuthListener(){
      if(!cloudOK) return;
      onAuthStateChanged(auth, (user)=>{ adminEmail = user ? (user.email || null) : null; });
    }

    function startProductsListener(){
      try{
        const q = query(collection(db, "products"));
        unsubscribeProducts?.();
        unsubscribeProducts = onSnapshot(q, (snap)=>{
          products.clear();
          snap.forEach(docSnap=>{ products.set(docSnap.id, { id:docSnap.id, ...docSnap.data() }); });
          persistLocal();
          renderAll();
          ui.statusText.textContent = "Online (Cloud)";
        }, (err)=>{
          console.warn("Snapshot error", err);
          ui.statusText.textContent = "Firestore-Fehler (lokal)";
          loadLocal(); renderAll();
        });
      }catch(e){
        console.warn("Listener failed", e);
        ui.statusText.textContent = "Offline (lokal)";
        loadLocal(); renderAll();
      }
    }

    function startOrdersListener(){
      try{
        const q = query(collection(db, "orders"));
        unsubscribeOrders?.();
        unsubscribeOrders = onSnapshot(q, (snap)=>{
          const remote = new Map();
          snap.forEach(docSnap=>{ remote.set(docSnap.id, { id:docSnap.id, ...docSnap.data() }); });
          for(const [id,ord] of remote) orders.set(id, ord);
          saveOrdersLocal();
          if(adminMode && adminView==="orders") renderOrdersList();
        }, (err)=>{
          console.warn("Orders snapshot error", err);
          loadOrdersLocal(); if(adminMode && adminView==="orders") renderOrdersList();
        });
      }catch(e){
        console.warn("Orders listener failed", e);
        loadOrdersLocal(); if(adminMode && adminView==="orders") renderOrdersList();
      }
    }

    function priceParts(item){
      const p = Number(item.price||0);
      const d = Number(item.discount||0);
      if(d>0){ const now = Math.max(0, p * (1 - d/100)); return { now, old:p, discount:d }; }
      return { now:p, old:null, discount:0 };
    }

    function makeBadge(txt, cls){
      const b = document.createElement("div");
      b.className = "sbadge " + cls;
      b.textContent = txt;
      return b;
    }

    function renderCard(item){
      const { now, old } = priceParts(item);
      const y = item.youtube || "";
      const card = document.createElement("article");
      card.className = "card";
      card.dataset.id = item.id;

      const imgWrap = document.createElement("div");
      imgWrap.className = "img";
      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = item.name || "Artikel";
      img.src = item.image || "https://raw.githubusercontent.com/simple-icons/simple-icons/develop/icons/youtubegaming.svg";
      imgWrap.appendChild(img);
      card.appendChild(imgWrap);

      if(y) {
        const yb = document.createElement("div");
        yb.className = "y-badge";
        yb.textContent = "YouTube";
        card.appendChild(yb);
        yb.addEventListener("click",(e)=>{ e.stopPropagation(); window.open(y, "_blank", "noreferrer"); });
      }

      const c = document.createElement("div");
      c.className = "content";
      const h3 = document.createElement("h3");
      h3.textContent = item.name || "Artikel";
      c.appendChild(h3);

      // Preis links
      const pr = document.createElement("div");
      pr.className = "price";
      const nowEl = document.createElement("div");
      nowEl.className = "now";
      nowEl.textContent = isNaN(now) ? "-" : fmtEUR(now);
      pr.appendChild(nowEl);
      if(old){
        const oldEl = document.createElement("div");
        oldEl.className = "old";
        oldEl.textContent = fmtEUR(old);
        pr.appendChild(oldEl);
      }

      // Status rechts daneben
      const sb = document.createElement("div"); sb.className = "status-badges";
      const avail = item.availability || "available";
      if(avail === "available"){ sb.appendChild(makeBadge("Vorhanden", "s-available")); }
      if(avail === "out_of_stock"){ sb.appendChild(makeBadge("Ausverkauft", "s-oos")); }
      if(avail === "not_available"){ sb.appendChild(makeBadge("Nicht erhältlich", "s-na")); }
      if(item.ownBrand){ sb.appendChild(makeBadge("Eigen Marke", "s-own")); }

      const priceRow = document.createElement("div");
      priceRow.className = "price-row";
      priceRow.append(pr, sb);
      c.appendChild(priceRow);

      const actions = document.createElement("div");
      actions.className = "actions";
      const addBtn = document.createElement("button");
      addBtn.className = "btn primary";
      addBtn.type="button";
      addBtn.textContent = "In den Warenkorb";
      // Disable by availability
      if(avail !== "available"){
        addBtn.disabled = true;
        addBtn.classList.remove("primary");
        addBtn.classList.add("ghost");
        addBtn.textContent = (avail === "out_of_stock") ? "Ausverkauft" : "Nicht erhältlich";
      }
      addBtn.addEventListener("click", (e)=>{ e.stopPropagation(); addToCart(item.id, 1); });
      actions.appendChild(addBtn);
      c.appendChild(actions);

      card.appendChild(c);

      card.addEventListener("click", ()=>{
        if(!adminMode) return;
        openEdit(item.id);
      });

      return card;
    }

    function renderAll(){
      const term = ui.search.value.trim().toLowerCase();
      const grid = ui.grid;
      grid.textContent = "";
      const list = Array.from(products.values()).filter(item=>{
        const catOk = (currentCategory === "alle") || (item.category === currentCategory);
        const termOk = !term || (item.name?.toLowerCase().includes(term));
        return catOk && termOk;
      }).sort((a,b)=> (a.name||"").localeCompare((b.name||""), "de", {sensitivity:"base"}));
      list.forEach(item=> grid.appendChild(renderCard(item)));
      if(adminMode) (adminView==="orders" ? renderOrdersList() : renderAdminList());
    }

    // ---- Admin LIST (Produkte) ----
    function renderAdminList(){
      if(!adminMode || adminView!=="products"){ ui.list.textContent = ""; ui.adminFilters.style.display="none"; ui.orderFilters.style.display="none"; return; }
      ui.adminFilters.style.display="grid";
      ui.orderFilters.style.display="none";

      const frag = document.createDocumentFragment();
      if(!productsDraft) productsDraft = new Map(products);

      const filtered = Array.from(productsDraft.values()).filter(item=>{
        const t = adminSearchTerm ? (item.name||"").toLowerCase().includes(adminSearchTerm) : true;
        const c = adminCatTerm ? item.category === adminCatTerm : true;
        let s = true;
        if(adminStatusTerm === "available") s = (item.availability||"available") === "available";
        else if(adminStatusTerm === "out_of_stock") s = (item.availability||"available") === "out_of_stock";
        else if(adminStatusTerm === "not_available") s = (item.availability||"available") === "not_available";
        else if(adminStatusTerm === "own") s = !!item.ownBrand;
        return t && c && s;
      }).sort((a,b)=> (a.name||"").localeCompare((b.name||""), "de", {sensitivity:"base"}));

      filtered.forEach(item=>{
        const row = document.createElement("div");
        row.className = "admin-item";
        row.dataset.id = item.id;

        // Zeile 1: Name + Kategorie
        const row1 = document.createElement("div"); row1.className="row";
        const name = document.createElement("input"); name.value = item.name||""; name.placeholder="Name"; name.autocomplete="off";
        const cat = document.createElement("select");
        ["Raketen","Verbünde","Batterien","Böller","Vulkane","Fontänen","Leucht","Sortiment","Sonstiges"].forEach(v=>{
          const o=document.createElement("option"); o.value=v; o.textContent=v; if(item.category===v) o.selected=true; cat.appendChild(o);
        });
        row1.append(name, cat);

        // Zeile 2: Preis & Rabatt
        const row2 = document.createElement("div"); row2.className="row";
        const price = document.createElement("input"); price.type="number"; price.step="0.01"; price.value = item.price ?? ""; price.placeholder="Preis (€)"; price.inputMode="decimal";
        const discount = document.createElement("input"); discount.type="number"; discount.step="1"; discount.min=0; discount.max=95; discount.value=item.discount ?? ""; discount.placeholder="Rabatt (%)"; discount.inputMode="numeric";
        row2.append(price, discount);

        // Zeile 3: Bild/YouTube
        const image = document.createElement("input"); image.placeholder="Bild-URL"; image.value=item.image ?? "";
        const youtube = document.createElement("input"); youtube.placeholder="YouTube-URL"; youtube.value=item.youtube ?? "";

        // Zeile 4: Status-Toggles
        const stat = document.createElement("div"); stat.className="toggle-group";
        const btnAvail = document.createElement("button"); btnAvail.className="tbtn t-available"; btnAvail.type="button"; btnAvail.textContent="Vorhanden";
        const btnOOS = document.createElement("button"); btnOOS.className="tbtn t-oos"; btnOOS.type="button"; btnOOS.textContent="Ausverkauft";
        const btnNA = document.createElement("button"); btnNA.className="tbtn t-na"; btnNA.type="button"; btnNA.textContent="Nicht erhältlich";
        const btnOWN = document.createElement("button"); btnOWN.className="tbtn t-own"; btnOWN.type="button"; btnOWN.textContent="Eigen Marke";

        function applyActive(){
          const av = (item.availability || "available");
          btnAvail.classList.toggle("active", av==="available");
          btnOOS.classList.toggle("active", av==="out_of_stock");
          btnNA.classList.toggle("active", av==="not_available");
          btnOWN.classList.toggle("active", !!item.ownBrand);
        }
        applyActive();

        btnAvail.addEventListener("click", ()=>{ setDraft(item.id, { availability:"available" }); item.availability="available"; applyActive(); });
        btnOOS.addEventListener("click", ()=>{ setDraft(item.id, { availability:"out_of_stock" }); item.availability="out_of_stock"; applyActive(); });
        btnNA.addEventListener("click", ()=>{ setDraft(item.id, { availability:"not_available" }); item.availability="not_available"; applyActive(); });
        btnOWN.addEventListener("click", ()=>{ const nv=!item.ownBrand; setDraft(item.id, { ownBrand:nv }); item.ownBrand=nv; applyActive(); });

        stat.append(btnAvail, btnOOS, btnNA, btnOWN);

        // Zeile 5: Aktionen
        const act = document.createElement("div"); act.className="row";
        const btnShow = document.createElement("button"); btnShow.className="btn"; btnShow.type="button"; btnShow.textContent="Anzeigen";
        const btnSaveOne = document.createElement("button"); btnSaveOne.className="btn"; btnSaveOne.type="button"; btnSaveOne.textContent="Speichern";
        const btnDeleteOne = document.createElement("button"); btnDeleteOne.className="btn ghost"; btnDeleteOne.type="button"; btnDeleteOne.textContent="Löschen";
        const btnOpen = document.createElement("button"); btnOpen.className="btn"; btnOpen.type="button"; btnOpen.textContent="Öffnen";

        act.append(btnShow, btnSaveOne, btnDeleteOne, btnOpen);

        // Zusammenbauen
        row.append(row1, row2, image, youtube, stat, act);

        // Input-Handler
        [name, cat, price, discount, image, youtube].forEach((el)=>{
          el.addEventListener("input", ()=>{
            const cur = Object.assign({}, item, {
              name: name.value,
              category: cat.value,
              price: parseFloat(price.value || "0"),
              discount: parseInt(discount.value || "0"),
              image: image.value,
              youtube: youtube.value
            });
            setDraft(item.id, cur);
            Object.assign(item, cur);
          });
        });

        // Buttons
        btnOpen.addEventListener("click", ()=> openEdit(item.id));
        btnShow.addEventListener("click", ()=> openEdit(item.id));

        btnSaveOne.addEventListener("click", async()=>{
          const cur = productsDraft.get(item.id) || item;
          products.set(item.id, cur);
          persistLocal();
          renderAll();
          if(cloudOK && adminEmail){
            try{ await setDoc(doc(db,"products", item.id), cur, {merge:true}); showToast("Artikel gespeichert"); }
            catch(e){ console.warn(e); showToast("Cloud-Fehler, lokal gespeichert"); }
          }else{ showToast("Lokal gespeichert"); }
          renderAdminList();
        });

        btnDeleteOne.addEventListener("click", async()=>{
          if(!confirm("Diesen Artikel wirklich löschen?")) return;
          products.delete(item.id);
          productsDraft && productsDraft.delete(item.id);
          persistLocal();
          renderAll();
          if(cloudOK && adminEmail){
            try{ await deleteDoc(doc(db,"products", item.id)); showToast("Artikel gelöscht"); }
            catch(e){ console.warn(e); showToast("Cloud-Fehler beim Löschen"); }
          }
          renderAdminList();
        });

        frag.appendChild(row);
      });

      ui.list.textContent = "";
      ui.list.appendChild(frag);
    }

    function setDraft(id, patch){
      if(!productsDraft) productsDraft = new Map(products);
      const cur = Object.assign({}, productsDraft.get(id) || { id }, patch);
      productsDraft.set(id, cur);
    }

    // ---- Admin LIST (Bestellungen) ----
    function renderOrdersList(){
      if(!adminMode || adminView!=="orders"){ ui.list.textContent = ""; ui.adminFilters.style.display="none"; ui.orderFilters.style.display="none"; return; }
      ui.adminFilters.style.display="none";
      ui.orderFilters.style.display="grid";

      const frag = document.createDocumentFragment();
      const f = Array.from(orders.values())
        .filter(o=>{
          if(!orderSearchTerm) return true;
          const n = (o.name||"").toLowerCase();
          const c = (o.code||"").toLowerCase();
          return n.includes(orderSearchTerm) || c.includes(orderSearchTerm);
        })
        .sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

      f.forEach(order=>{
        let draft = ordersDraft.get(order.id);
        if(!draft){ draft = JSON.parse(JSON.stringify(order)); ordersDraft.set(order.id, draft); }

        const row = document.createElement("div");
        row.className = "admin-item";
        row.dataset.id = order.id;

        const left = document.createElement("div");

        const head = document.createElement("div");
        head.className = "order-head";
        const name = document.createElement("input"); name.placeholder="Kundenname"; name.value = draft.name||"";
        const status = document.createElement("select");
        ["neu","in_bearbeitung","fertig","storniert"].forEach(s=>{
          const o = document.createElement("option"); o.value=s; o.textContent=s.replace("_"," "); if(draft.status===s) o.selected=true; status.appendChild(o);
        });
        head.append(name, status);

        const code = document.createElement("div"); code.className="pill"; code.textContent = "Code: " + (draft.code||"-");
        code.style.margin="8px 0";

        const itemsWrap = document.createElement("div"); itemsWrap.className="order-items";
        const items = draft.itemsDetailed || [];

        // Summary
        const summaryTitle = document.createElement("div"); summaryTitle.className="muted"; summaryTitle.textContent="Artikel:";
        const summaryList = document.createElement("div"); summaryList.className="summary-list";
        (items||[]).forEach(it=>{ const line=document.createElement("div"); line.className="summary-line"; line.textContent=(it.name||"Artikel")+" ×"+(it.qty||0); summaryList.appendChild(line); });

        // Rows
        items.forEach((it, idx)=>{
          const r = document.createElement("div"); r.className="order-row";
          const inName = document.createElement("input"); inName.placeholder="Artikelname"; inName.value=it.name||"";
          const inQty = document.createElement("input"); inQty.type="number"; inQty.min="0"; inQty.step="1"; inQty.value = it.qty||0;
          const inPrice = document.createElement("input"); inPrice.type="number"; inPrice.step="0.01"; inPrice.value = it.unitPrice||0;
          const chk = document.createElement("input"); chk.type="checkbox"; chk.checked = !!it.done;
          const del = document.createElement("button"); del.className="btn ghost"; del.type="button"; del.textContent="✕";

          del.addEventListener("click", ()=>{ items.splice(idx,1); order.itemsDetailed = items; orders.set(order.id, order); saveOrdersLocal(); renderOrdersList(); });
          inName.addEventListener("input", ()=>{ it.name = inName.value; });
          inQty.addEventListener("input", ()=>{ it.qty = parseInt(inQty.value||"0"); });
          inPrice.addEventListener("input", ()=>{ it.unitPrice = parseFloat(inPrice.value||"0"); });
          chk.addEventListener("change", ()=>{ it.done = chk.checked; });

          const chkWrap = document.createElement("div"); chkWrap.className="chk"; chkWrap.appendChild(chk);
          r.append(inName, inQty, inPrice, chkWrap, del);
          itemsWrap.appendChild(r);
        });

        const addBtn = document.createElement("button"); addBtn.className="btn"; addBtn.type="button"; addBtn.textContent="Artikel +";
        addBtn.addEventListener("click", ()=>{ (order.itemsDetailed ||= []).push({productId:null, name:"", unitPrice:0, qty:1, done:false}); orders.set(order.id, order); saveOrdersLocal(); renderOrdersList(); });

        const sum = document.createElement("div"); sum.style.marginTop="8px"; sum.className="pill";
        sum.textContent = "Summe: " + fmtEUR(calcOrderSum(draft));

        const btnSave = document.createElement("button"); btnSave.className="btn"; btnSave.type="button"; btnSave.textContent="Speichern";
        const btnDel = document.createElement("button"); btnDel.className="btn ghost"; btnDel.type="button"; btnDel.textContent="Löschen";
        const btnRow = document.createElement("div"); btnRow.className="row"; btnRow.style.marginTop="8px";
        btnRow.append(btnSave, btnDel);

        left.append(head, code, summaryTitle, summaryList, itemsWrap, addBtn, sum, btnRow);
        row.append(left);
        frag.appendChild(row);

        btnSave.addEventListener("click", async()=>{
          draft.name = name.value;
          draft.status = status.value;
          draft.itemsDetailed = items;
          draft.subtotal = calcOrderSum(draft);
          orders.set(draft.id, JSON.parse(JSON.stringify(draft))); saveOrdersLocal();
          if(cloudOK && adminEmail){
            try{ await setDoc(doc(db,"orders", draft.id), draft, {merge:true}); showToast("Bestellung gespeichert"); }
            catch(e){ console.warn(e); showToast("Cloud-Fehler, lokal gespeichert"); }
          }else{ showToast("Lokal gespeichert"); }
          renderOrdersList();
        });
        btnDel.addEventListener("click", async()=>{
          if(!confirm("Bestellung wirklich löschen?")) return;
          orders.delete(order.id); saveOrdersLocal();
          if(cloudOK && adminEmail){
            try{ await deleteDoc(doc(db,"orders", order.id)); showToast("Bestellung gelöscht"); }
            catch(e){ console.warn(e); showToast("Cloud-Fehler beim Löschen"); }
          }
          renderOrdersList();
        });
      });

      ui.list.textContent = "";
      ui.list.appendChild(frag);
    }

    function calcOrderSum(order){ const items = (order && order.itemsDetailed) || []; let s=0; for(const it of items){ s += (Number(it.unitPrice)||0) * (Number(it.qty)||0); } return s; }

    function openEdit(id){
      try{ closeAdmin(); }catch(e){}
      editingId = id || crypto.randomUUID();
      const item = products.get(editingId) || { id:editingId, name:"", category:"Batterien", price:0, discount:0, image:"", youtube:"", availability:"available", ownBrand:false };
      ui.editTitle.textContent = (products.has(editingId) ? "Artikel bearbeiten" : "Artikel hinzufügen");
      ui.fName.value = item.name||""; ui.fCategory.value = item.category||"Batterien"; ui.fPrice.value = item.price ?? "";
      ui.fDiscount.value = item.discount ?? ""; ui.fImage.value = item.image ?? ""; ui.fYouTube.value = item.youtube ?? "";
      openModal(ui.editModal);
    }

    async function saveEditing(){
      const id = editingId || crypto.randomUUID();
      const base = products.get(id) || {};
      const item = {
        id,
        name: ui.fName.value.trim(),
        category: ui.fCategory.value,
        price: parseFloat(ui.fPrice.value || "0"),
        discount: parseInt(ui.fDiscount.value || "0"),
        image: ui.fImage.value.trim(),
        youtube: ui.fYouTube.value.trim(),
        availability: base.availability || "available",
        ownBrand: !!base.ownBrand
      };
      products.set(id, item);
      persistLocal();
      renderAll();
      if(cloudOK && adminEmail){
        try{ await setDoc(doc(db, "products", id), item, { merge:true }); showToast("Gespeichert (Cloud)"); }
        catch(e){ console.warn(e); showToast("Firestore-Fehler, lokal gespeichert"); }
      }else{ showToast("Lokal gespeichert"); }
      closeModal(ui.editModal);
    }

    async function deleteEditing(){
      if(!editingId) return; const id = editingId;
      products.delete(id); persistLocal(); renderAll();
      if(cloudOK && adminEmail){
        try{ await deleteDoc(doc(db, "products", id)); showToast("Gelöscht (Cloud)"); }
        catch(e){ console.warn(e); showToast("Firestore-Fehler beim Löschen"); }
      }
      closeModal(ui.editModal);
    }

    // ===== Cart =====
    function addToCart(id, qty=1){ const cur = cart.get(id) || 0; cart.set(id, Math.max(1, cur + qty)); saveCart(); showToast("Zum Warenkorb hinzugefügt"); }
    function setQty(id, qty){ if(qty<=0){ cart.delete(id); } else { cart.set(id, qty); } saveCart(); renderCart(); }
    function removeFromCart(id){ cart.delete(id); saveCart(); renderCart(); }
    function cartItems(){ return Array.from(cart.entries()).map(([id,qty])=>({id, qty:Number(qty)||0, item: products.get(id)})); }
    function cartSubtotalValue(){ let s=0; for(const {item, qty} of cartItems()){ if(item){ const {now}=priceParts(item); s += (now||0)*(qty||0); } } return s; }
    function renderCart(){
      const list = ui.cartList;
      list.textContent = "";
      const items = cartItems();
      if(items.length===0){
        const empty = document.createElement("div");
        empty.className="muted";
        empty.textContent = "Dein Warenkorb ist leer.";
        list.appendChild(empty);
      }else{
        for(const {id, qty, item} of items){
          const row = document.createElement("div");
          row.className = "cart-item";
          const left = document.createElement("div");
          const title = document.createElement("div");
          title.style.fontWeight="700"; title.textContent = item?.name || ("Artikel " + id);
          const price = document.createElement("div"); price.className="muted";
          const pp = item ? priceParts(item).now : 0;
          price.textContent = fmtEUR(pp) + " • " + (item?.category || "");
          left.append(title, price);

          const right = document.createElement("div"); right.className = "qty";
          const minus = document.createElement("button"); minus.className="btn"; minus.type="button"; minus.textContent="-";
          const q = document.createElement("span"); q.textContent = String(qty);
          const plus = document.createElement("button"); plus.className="btn"; plus.type="button"; plus.textContent="+";
          const del = document.createElement("button"); del.className="btn ghost"; del.type="button"; del.textContent="✕";
          minus.addEventListener("click", ()=> setQty(id, qty-1));
          plus.addEventListener("click", ()=> setQty(id, qty+1));
          del.addEventListener("click", ()=> removeFromCart(id));
          right.append(minus, q, plus, del);

          row.append(left, right);
          list.appendChild(row);
        }
      }
      ui.cartSubtotal.textContent = fmtEUR(cartSubtotalValue());
      updateCartBadge();
    }
    function openCart(){ renderCart(); openModal(ui.cartModal); }
    function clearCart(){ cart.clear(); saveCart(); renderCart(); }

    function genCode(){ const AL="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s="BP-"; for(let i=0;i<6;i++){ s+= AL[Math.floor(Math.random()*AL.length)]; } return s; }
    function openCheckout(){ ui.coName.value = ""; ui.coCode.value = genCode(); openModal(ui.checkoutModal); }

    async function finalizeCheckout(){
      const name = ui.coName.value.trim();
      const code = ui.coCode.value.trim();
      if(!name){ showToast("Bitte Namen eingeben"); return; }
      const items = cartItems();
      if(items.length===0){ showToast("Warenkorb ist leer"); return; }
      const itemsDetailed = items.map(({id, qty, item})=>{
        const pp = item ? priceParts(item).now : 0;
        return { productId:id, name:item?.name||("Artikel "+id), unitPrice: pp, qty, done:false };
      });
      const order = {
        id: crypto.randomUUID(),
        code, name,
        status: "neu",
        itemsDetailed,
        subtotal: itemsDetailed.reduce((a,b)=> a + (b.unitPrice*b.qty), 0),
        createdAt: new Date().toISOString(),
        source: "web"
      };
      orders.set(order.id, order); saveOrdersLocal();
      if(cloudOK){
        try{ await setDoc(doc(db,"orders", order.id), order, {merge:true}); }
        catch(e){ console.warn("Order write failed", e); }
      }
      clearCart();
      closeModal(ui.checkoutModal);
      closeModal(ui.cartModal);
      showToast("Bestellung gesendet – Code: " + code, 4000);
    }

    // ===== Admin =====
    function openAdmin(){ adminMode = true; ui.panel.style.display = "flex"; adminView = "products"; renderAdminList(); }
    function closeAdmin(){ adminMode = false; ui.panel.style.display = "none"; productsDraft=null; ordersDraft = new Map(); }

    async function handleAdminLogin(passOrEmail, pass){
      const email = pass && passOrEmail ? passOrEmail : null;
      const passCode = pass ? pass : passOrEmail;
      if(email && cloudOK){
        try{ await signInWithEmailAndPassword(auth, email, pass); openAdmin(); return true; }
        catch(e){ console.warn("Auth failed", e); showToast("Login fehlgeschlagen"); }
      }
      if(passCode === (localStorage.getItem("bp_admin_code") || "BLOCK2025")){ openAdmin(); return true; }
      showToast("Zugang verweigert"); return false;
    }
    async function adminLogout(){ try{ if(cloudOK){ await signOut(auth); } }catch(e){} closeAdmin(); showToast("Abgemeldet"); }

    function downloadFile(name, dataStr, type="application/json"){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([dataStr], {type}));
      a.download = name;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
    }
    function exportJSON(){ const obj = Object.fromEntries(products); downloadFile("block-pyro-products.json", JSON.stringify(obj, null, 2)); }
    function importJSON(){
      const inp = document.createElement("input");
      inp.type="file"; inp.accept=".json,application/json";
      inp.addEventListener("change", ()=>{
        const file = inp.files?.[0]; if(!file) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{ const obj = JSON.parse(r.result); products = new Map(Object.entries(obj)); persistLocal(); renderAll(); showToast("Importiert"); }
          catch(e){ showToast("Import fehlgeschlagen") }
        };
        r.readAsText(file);
      });
      inp.click();
    }
    async function saveAll(){
      if(productsDraft){ products = new Map(productsDraft); productsDraft=null; }
      persistLocal();
      renderAll();
      if(cloudOK && adminEmail){
        try{
          await Promise.all(Array.from(products.values()).map(it => setDoc(doc(db,"products", it.id), it, {merge:true})));
          showToast("Alle Artikel in die Cloud gespeichert");
        }catch(e){ console.warn(e); showToast("Firestore-Fehler – lokal gespeichert"); }
      }else{ showToast("Lokal gespeichert (kein Cloud-Login)"); }
    }

    // Events / UI
    ui.btnAdminOpen.addEventListener("click", ()=> { openModal(ui.loginModal); setTimeout(()=> ui.loginPass.focus(), 60); });
    ui.btnAdminClose.addEventListener("click", closeAdmin);
    ui.btnLogout.addEventListener("click", adminLogout);
    ui.btnAdd.addEventListener("click", ()=> openEdit(null));
    ui.btnSaveAll.addEventListener("click", saveAll);
    ui.btnExport.addEventListener("click", exportJSON);
    ui.btnImport.addEventListener("click", importJSON);
    ui.btnClearLocal.addEventListener("click", ()=>{
      if(confirm("Lokalen Speicher wirklich löschen?")){ localStorage.removeItem(LS_KEY); products.clear(); renderAll(); }
    });
    ui.btnCloudRetry.addEventListener("click", ()=>{ startProductsListener(); startOrdersListener(); showToast("Verbinde…"); });
    ui.btnReload.addEventListener("click", ()=> location.reload());
    ui.btnShowProducts.addEventListener("click", ()=>{
      adminView="products"; if(!productsDraft) productsDraft = new Map(products); renderAdminList();
      document.getElementById("btnTabProducts")?.classList.add("ghost");
      document.getElementById("btnTabOrders")?.classList.remove("ghost");
    });
    ui.btnShowOrders.addEventListener("click", ()=>{
      adminView="orders"; ordersDraft = new Map(); renderOrdersList();
      document.getElementById("btnTabOrders")?.classList.add("ghost");
      document.getElementById("btnTabProducts")?.classList.remove("ghost");
      if(cloudOK) startOrdersListener(); else loadOrdersLocal();
    });

    ui.search.addEventListener("input", renderAll);
    ui.catBar.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        ui.catBar.querySelectorAll(".chip").forEach(c=> c.classList.remove("active"));
        ch.classList.add("active"); currentCategory = ch.dataset.cat; renderAll();
      });
    });

    // Admin filter listeners
    ui.adminSearch.addEventListener("input", ()=>{ adminSearchTerm = ui.adminSearch.value.trim().toLowerCase(); renderAdminList(); });
    ui.adminCatFilter.addEventListener("change", ()=>{ adminCatTerm = ui.adminCatFilter.value; renderAdminList(); });
    ui.adminStatusFilter.addEventListener("change", ()=>{ adminStatusTerm = ui.adminStatusFilter.value; renderAdminList(); });

    // Order search
    ui.orderSearch.addEventListener("input", ()=>{ orderSearchTerm = ui.orderSearch.value.trim().toLowerCase(); renderOrdersList(); });

    // Tabs oben (Spiegelung)
    const tabProd = document.getElementById("btnTabProducts");
    const tabOrd = document.getElementById("btnTabOrders");
    tabProd?.addEventListener("click", ()=>{ adminView="products"; if(!productsDraft) productsDraft = new Map(products); renderAdminList(); tabProd.classList.add("ghost"); tabOrd.classList.remove("ghost"); });
    tabOrd?.addEventListener("click", ()=>{ adminView="orders"; ordersDraft = new Map(); renderOrdersList(); tabOrd.classList.add("ghost"); tabProd.classList.remove("ghost"); if(cloudOK) startOrdersListener(); else loadOrdersLocal(); });

    // Login modal
    document.getElementById("loginCancel").addEventListener("click", ()=> closeModal(ui.loginModal));
    document.getElementById("loginOk").addEventListener("click", async()=>{
      const em = ui.loginEmail.value.trim();
      const pw = ui.loginPass.value.trim();
      await handleAdminLogin(em || pw, em ? pw : null);
      closeModal(ui.loginModal);
    });
    ui.loginPass.addEventListener("keydown", async(e)=>{
      if(e.key==="Enter"){
        const em = ui.loginEmail.value.trim();
        const pw = ui.loginPass.value.trim();
        await handleAdminLogin(em || pw, em ? pw : null);
        closeModal(ui.loginModal);
      }
    });

    // Cart + Checkout modals
    ui.btnCart.addEventListener("click", openCart);
    ui.cartClose.addEventListener("click", ()=> closeModal(ui.cartModal));
    ui.cartClear.addEventListener("click", clearCart);
    ui.cartCheckout.addEventListener("click", ()=>{ closeModal(ui.cartModal); openCheckout(); });
    ui.coCancel.addEventListener("click", ()=>{ closeModal(ui.checkoutModal); openCart(); });
    ui.coConfirm.addEventListener("click", finalizeCheckout);
    // --- FIX: Add/Edit modal buttons wired ---
    ui.editCancel.addEventListener("click", ()=> closeModal(ui.editModal));
    ui.editSave.addEventListener("click", saveEditing);
    ui.editDelete.addEventListener("click", deleteEditing);


    // Modals
    function openModal(el){ el.style.display="flex"; document.body.classList.add("modal-open"); ["header","#adminPanel",".floating"].forEach(sel=>{ const x=document.querySelector(sel); if(x) x.setAttribute("inert",""); }); }
    function closeModal(el){ el.style.display="none"; if(!anyModalOpen()){ document.body.classList.remove("modal-open"); ["header","#adminPanel",".floating"].forEach(sel=>{ const x=document.querySelector(sel); if(x) x.removeAttribute("inert"); }); } }
    function anyModalOpen(){ try { return [document.getElementById("loginModal"), document.getElementById("editModal"), document.getElementById("cartModal"), document.getElementById("checkoutModal")].some(m => m && m.style.display==='flex'); } catch(e){ return false; } }
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape"){ if(document.getElementById("checkoutModal").style.display==="flex") closeModal(document.getElementById("checkoutModal")); else if(document.getElementById("cartModal").style.display==="flex") closeModal(document.getElementById("cartModal")); else if(document.getElementById("editModal").style.display==="flex") closeModal(document.getElementById("editModal")); else if(document.getElementById("loginModal").style.display==="flex") closeModal(document.getElementById("loginModal")); }});

    // Boot
    bootFirebase();

    // --- Vertical-only swipe guard ---
    (function(){
      let startX=0, startY=0;
      function isInteractive(el){ return el.closest('.modal, button, a, input, textarea, select, .btn, [role="button"]'); }
      window.addEventListener('touchstart', (e)=>{ if(e.touches && e.touches.length===1){ startX = e.touches[0].clientX; startY = e.touches[0].clientY; } }, {passive:true});
      window.addEventListener('touchmove', (e)=>{
        if(e.touches && e.touches.length===1){
          if(isInteractive(e.target)) return;
          const dx = Math.abs(e.touches[0].clientX - startX);
          const dy = Math.abs(e.touches[0].clientY - startY);
          if(dx > dy + 12){ e.preventDefault(); }
        }
      }, {passive:false});
      window.addEventListener('wheel', (e)=>{ if(Math.abs(e.deltaX) > Math.abs(e.deltaY)){ e.preventDefault(); } }, {passive:false});
    })();

    // Demo content when empty
    setTimeout(()=>{
      if(products.size===0){
        const demo = [
          {id:crypto.randomUUID(), name:"Sky Thunder 25", category:"Batterien", price:19.99, discount:0, image:"https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop", youtube:"", availability:"available", ownBrand:false},
          {id:crypto.randomUUID(), name:"Galactic Rockets", category:"Raketen", price:29.9, discount:10, image:"https://images.unsplash.com/photo-1507413245164-6160d8298b31?q=80&w=1200&auto=format&fit=crop", youtube:"", availability:"out_of_stock", ownBrand:true},
          {id:crypto.randomUUID(), name:"Mega Verbund V2", category:"Verbünde", price:119.0, discount:15, image:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1200&auto=format&fit=crop", youtube:"", availability:"not_available", ownBrand:false}
        ];
        demo.forEach(it=> products.set(it.id, it));
        persistLocal(); renderAll();
      }
    }, 800);
  </script>

  <script>
  // Logo-Fallback von GitHub Raw
  (function(){
    const img = document.querySelector('#brandLogo, .logo-img, header .logo img');
    if(!img) return;
    function onErr(){
      if(img.dataset.fallbackApplied) return;
      img.dataset.fallbackApplied = "1";
      img.src = 'https://raw.githubusercontent.com/blockpyrotechnics/Block_Pyrotechnics/refs/heads/main/assets/logo.png';
    }
    img.addEventListener('error', onErr, {once:true});
  })();
  </script>

</body>
</html>
